<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 

CREATE TABLE FUN_PROJECT(
   SEQ NUMBER(8) PRIMARY KEY,
   ID VARCHAR2(50) NOT NULL,
   
   FUNDTYPE VARCHAR2(50) NOT NULL, // REWARD | DONATION
   CATEGORY VARCHAR2(50) NOT NULL, // FOOD, ANIMAL, IT | ANIMAL, HUMAN
   TITLE VARCHAR2(200) NOT NULL, 
   CONTENT VARCHAR2(4000) NOT NULL,
   SUMMARY VARCHAR2(1000) NOT NULL,
   TAGS VARCHAR2(400),
   BANK VARCHAR2(200) NOT NULL,
   GOALFUND NUMBER(10) NOT NULL,
   
   SDATE DATE NOT NULL,
   EDATE DATE NOT NULL,
   PDATE DATE NOT NULL, // 결제일
   SHIPDATE DATE, // DATE로 변경  // 배송일 ==> 기부인 경우 배송이 없으므로 NOT NULL 삭제
   REGDATE DATE NOT NULL,
   
   STATUS VARCHAR2(50) NOT NULL // 1: 준비중, 2: 승인대기, 3: 진행중, 4: 완료됨(성공), 5: 완료됨(실패), 6: 삭제
);

CREATE SEQUENCE SEQ_PROJECT
START WITH 1 INCREMENT BY 1;

ALTER TABLE FUN_PROJECT ADD CONSTRAINT PROJECT_ID_FK
FOREIGN KEY(ID)
REFERENCES FUN_MEMBER(ID)
ON DELETE CASCADE; // 종속 삭제(참조하는 데이터가 삭제되면 함께 삭제)

// VIEW : 프로젝트 전체 내용 

CREATE OR REPLACE VIEW FUN_PROJECTALL (SEQ, ID, FUNDTYPE, CATEGORY, TITLE, CONTENT, SUMMARY, TAGS, BANK, GOALFUND, SDATE, EDATE, PDATE, SHIPDATE, REGDATE, STATUS, QNACOUNT, BUYCOUNT, NOTICECOUNT, LIKECOUNT, FUNDACHIVED)
AS
SELECT P.SEQ, P.ID, P.FUNDTYPE, P.CATEGORY, P.TITLE, P.CONTENT, P.SUMMARY, P.TAGS, P.BANK, P.GOALFUND, P.SDATE, P.EDATE, P.PDATE, P.SHIPDATE, P.REGDATE, P.STATUS,
   NVL((SELECT COUNT(*) FROM FUN_QNA  GROUP BY PROJECTSEQ HAVING PROJECTSEQ = P.SEQ),0),
   NVL((SELECT COUNT(*) FROM FUN_BUY GROUP BY PROJECTSEQ HAVING PROJECTSEQ = P.SEQ),0),   
    NVL((SELECT COUNT(*) FROM FUN_NOTICE GROUP BY PROJECTSEQ HAVING PROJECTSEQ = P.SEQ),0),
    NVL((SELECT COUNT(*) FROM FUN_LIKE GROUP BY PROJECTSEQ HAVING PROJECTSEQ = P.SEQ),0),
    NVL((SELECT SUM(PRICE * COUNT) FROM FUN_BUY GROUP BY PROJECTSEQ HAVING PROJECTSEQ = P.SEQ),0)
FROM FUN_PROJECT P;

 -->

<!-- 프로젝트 -->  
<mapper namespace="Project">

<!-- 특정 프로젝트 정보 가져오기 -->
<select id="getProject" parameterType="java.lang.Integer" resultType="donzo.thefun.model.ProjectDto">
	SELECT * FROM FUN_PROJECTALL WHERE SEQ=#{seq}
</select>

<!-- detail 회사 정보 가져오기 -->
<select id="getWriter" parameterType="java.lang.Integer" resultType="donzo.thefun.model.MemberDto">
	SELECT * FROM FUN_MEMBER WHERE ID=(SELECT ID FROM FUN_PROJECT WHERE SEQ=#{seq})
</select>

<!-- 새 프로젝트 등록 -->
<!-- <insert id="newWrite" parameterType="donzo.thefun.model.ProjectDto">
	INSERT INTO FUN_PROJECT
	VALUES(SEQ_PROJECT.NEXTVAL, #{id},
			#{fundtype}, #{category}, 
			#{title}, #{content}, #{summary}, #{tag}, #{bank}, #{goalfund},
			TO_DATE(#{sdate}, 'yyyy-mm-dd'), TO_DATE(#{edate}, 'yyyy-mm-dd'), 
			TO_DATE(#{pdate}, 'yyyy-mm-dd'), TO_DATE(#{shipdate}, 'yyyy-mm-dd'), SYSDATE, '1')
</insert> -->

<!-- 프로젝트 seq 찾기 --> <!-- 수정하자 --> 
<!-- <select id="findProjectSeq" parameterType="donzo.thefun.model.ProjectDto"
		resultType="java.lang.Integer">
	SELECT SEQ
	FROM FUN_PROJECT
	WHERE ID=#{id}
	AND TITLE=#{title}
	AND SDATE=TO_DATE(#{sdate}, 'yyyy-mm-dd')
</select> -->

<!-- 새 프로젝트 등록 후 현재 seq 받아서 리턴 -->
<insert id="newWrite" parameterType="donzo.thefun.model.ProjectDto"> 
	INSERT INTO FUN_PROJECT
	VALUES(SEQ_PROJECT.NEXTVAL, #{id},
			#{fundtype}, #{category}, 
			#{title}, #{content}, #{summary}, #{tag}, #{bank}, #{goalfund},
			TO_DATE(#{sdate}, 'yyyy-mm-dd'), TO_DATE(#{edate}, 'yyyy-mm-dd'), 
			TO_DATE(#{pdate}, 'yyyy-mm-dd'), TO_DATE(#{shipdate}, 'yyyy-mm-dd'), SYSDATE, #{status})
	<selectKey keyProperty="seq" resultType="Integer" order="AFTER"> 
		SELECT SEQ_PROJECT.CURRVAL FROM dual 
	</selectKey>
</insert> 


</mapper>